{# ============================================
   改良版 Post テンプレート (Jinja2) — javmix-av.com
   目的: 収益/UX/SEO(A11y/構造化データ)を総合強化
   方針: has_offer=False（= 商品系は出さない）。構造化データは VideoObject のみ。
   想定: WordPress + FANZAScraper 生成HTMLとして本文に挿入
   注意: HLS再生(hls.js)はテーマ/共通JSで1度だけ読み込み推奨
   ============================================ #}

<article class="entry">
  {# ---------- 事前整形 ---------- #}
  {% set samples = item.sample_images.split("|") if item.sample_images else [] %}
  {% set poster  = item.trailer_poster or item.image_large or (samples[0] if samples else None) %}
  {% set _date   = (item.date.split(" ")[0] if item.date and (" " in item.date) else item.date) %}
  {% set tu      = item.trailer_url or '' %}
  {% set tu_l    = tu|lower|replace('\n','') %}
  {% set is_mp4  = (tu_l.endswith('.mp4') or ('.mp4?'  in tu_l)) %}
  {% set is_m3u8 = (tu_l.endswith('.m3u8') or ('.m3u8?' in tu_l)) %}
  {% set _max    = item._max_gallery|default(12) %}
  {# iframeサイズ（.env→CSVから入っている想定） #}
  {% set W = item.player_width  or 1280 %}
  {% set H = item.player_height or 720 %}
  {% set aff_url = item.aff_url %}

  {# ---------- 見出し ---------- #}
  {% if item.title %}
    <header class="entry__header">
      <h1 class="entry__title">{% if item.cid %}[{{ item.cid }}] {% endif %}{{ item.title }}</h1>
    </header>
  {% endif %}

  {# ---------- メタ情報 ---------- #}
  <section class="entry__meta" aria-label="作品情報">
    <dl class="meta">
      {% if item.maker %}<div class="meta__row"><dt>メーカー</dt><dd>{{ item.maker }}</dd></div>{% endif %}
      {% if item.actress %}<div class="meta__row"><dt>出演</dt><dd>{{ item.actress }}</dd></div>{% endif %}
      {% if _date %}<div class="meta__row"><dt>発売日</dt><dd><time datetime="{{ _date }}">{{ _date }}</time></dd></div>{% endif %}
      {% if item.cid %}<div class="meta__row"><dt>品番</dt><dd><code>{{ item.cid }}</code></dd></div>{% endif %}
      {% if item.genres %}<div class="meta__row"><dt>ジャンル</dt><dd>{{ item.genres }}</dd></div>{% endif %}
    </dl>
  </section>

  {# ---------- リード動画 / 画像 ---------- #}
  {% if item.trailer_embed %}
    {# A案：DMMのUI込みで確実にズレない 4:3 ボックス #}
    <div class="fanza-embed fanza-embed--ui" style="--w:{{W}}; --h:{{H}};">
      <iframe
        src="{{ item.trailer_embed }}"
        width="{{ W }}" height="{{ H }}"
        loading="lazy" allowfullscreen scrolling="no" frameborder="0">
      </iframe>
    </div>

  {% elif is_mp4 %}
    <figure class="lead-media">
      <video class="lead-media__video" controls preload="none" playsinline {% if poster %}poster="{{ poster }}"{% endif %}>
        <source src="{{ item.trailer_url }}" type="video/mp4">
      </video>
      {% if item.title %}<figcaption class="lead-media__cap">{{ item.title }} — 予告編</figcaption>{% endif %}
    </figure>

  {% elif is_m3u8 %}
    <figure class="lead-media">
      <video class="lead-media__video hls-player" controls preload="none" playsinline data-src="{{ item.trailer_url }}" {% if poster %}poster="{{ poster }}"{% endif %}></video>
      {% if item.title %}<figcaption class="lead-media__cap">{{ item.title }} — 予告編</figcaption>{% endif %}
    </figure>

  {% elif poster %}
    <figure class="lead-media">
      <a class="video-fallback" href="{{ item.URL }}" target="_blank" rel="sponsored noopener" aria-label="公式ページで動画を見る">
        <img src="{{ poster }}" alt="{{ item.title or '' }}" loading="lazy" decoding="async">
        <span class="playbtn" aria-hidden="true">▶</span>
      </a>
    </figure>
  {% endif %}

  {# ---------- CTA（1個だけ） ---------- #}
  {% if aff_url %}
    <p class="cta">
      <a class="cta__btn" href="{{ aff_url }}" target="_blank" rel="sponsored noopener">
        <span>作品ページを見る</span>
      </a>
    </p>
  {% endif %}

  {# ---------- ギャラリー ---------- #}
  {% if samples %}
    <section class="gallery" aria-label="サンプル画像">
      {% for u in samples[:_max] %}
        {% if u %}
          <figure class="gallery__item">
            <img src="{{ u }}" alt="{{ item.title or '' }} サンプル {{ loop.index }}" loading="lazy" decoding="async">
          </figure>
        {% endif %}
      {% endfor %}
    </section>
  {% endif %}

  {# ---------- JSON-LD (構造化データ：VideoObject のみ) ---------- #}
  {% if is_mp4 or is_m3u8 or poster %}
    {# poster が dict {large,list,small} の場合に URL へ正規化。空なら samples[0] にフォールバック #}
    {% set thumb = None %}
    {% if poster %}
      {% if poster is mapping %}
        {% set thumb = poster.large or poster.list or poster.small %}
      {% else %}
        {% set thumb = poster %}
      {% endif %}
    {% endif %}
    {% if not thumb and samples %}{% set thumb = samples[0] %}{% endif %}

    {% set video = {
      "@context":"https://schema.org",
      "@type":"VideoObject",
      "name": (item.title or "") ~ " 予告編",
      "description": item.description or item.title or ""
    } %}
    {% if thumb %}{% set _ = video.update({"thumbnailUrl": thumb}) %}{% endif %}

    {# uploadDate は ISO日時を最優先。無ければ日付→00:00:00+09:00 に正規化 #}
    {% set tz = site_tz or '+09:00' %}  {# 環境に合わせて。日本なら +09:00 #}
    {% if item.date_iso %}
      {% set upload_iso = item.date_iso %}
    {% elif _date %}
      {% set upload_iso = _date ~ 'T00:00:00' ~ tz %}
    {% else %}
      {% set upload_iso = None %}
    {% endif %}
    {% if upload_iso %}{% set _ = video.update({"uploadDate": upload_iso}) %}{% endif %}

    {# 実体があれば contentUrl、無ければ embedUrl #}
    {% if item.trailer_url %}
      {% set _ = video.update({"contentUrl": item.trailer_url}) %}
    {% elif item.trailer_embed %}
      {% set _ = video.update({"embedUrl": item.trailer_embed}) %}
    {% endif %}

    {% if item.URL %}{% set _ = video.update({"url": item.URL}) %}{% endif %}

    {# duration は 0 秒は出さない #}
    {% if item.trailer_duration and item.trailer_duration|int > 0 %}
      {% set dur = item.trailer_duration|int %}
      {% set h = (dur // 3600)|int %}
      {% set m = ((dur % 3600) // 60)|int %}
      {% set s = (dur % 60)|int %}
      {% set dur_iso = 'PT' ~ (h ~ 'H' if h) ~ (m ~ 'M' if (h or m)) ~ s ~ 'S' %}
      {% set _ = video.update({"duration": dur_iso}) %}
    {% endif %}

    {% if site_name and site_logo_url %}
      {% set _ = video.update({
        "publisher": {
          "@type": "Organization",
          "name": site_name,
          "logo": { "@type": "ImageObject", "url": site_logo_url }
        }
      }) %}
    {% endif %}
    <script type="application/ld+json">{{ video | tojson }}</script>
  {% endif %}

</article>

{# ---------- HLS 初期化(必要時のみ) ---------- #}
<script>
(function(){
  var el = document.querySelector('video.hls-player');
  if(!el) return;
  var src = el.getAttribute('data-src');
  if (!src) return;

  if (el.canPlayType('application/vnd.apple.mpegurl')) {
    el.src = src;
  } else if (window.Hls) {
    var hls = new Hls({ maxBufferLength: 30 });
    hls.loadSource(src);
    hls.attachMedia(el);
  } else {
    var p = el.parentNode;
    var a = document.createElement('a');
    a.href = src; a.textContent = 'サンプル動画を再生 (m3u8)'; a.rel = 'noopener'; a.target = '_blank';
    p.appendChild(a);
  }
})();
</script>

<style>
/* ====== Layout ====== */
.entry{
  --gap:14px;
  --radius:12px;
  --bg:#ffffff;
  --fg:#000000;
  --fg-weak:#333333;
  --brand:#f5d36a;
}
.entry{color:var(--fg)}
.entry a{color:inherit}

.entry__header{margin:0 0 .6rem}
.entry__title{font-size:clamp(1.05rem,1.4vw+1rem,1.8rem);line-height:1.35;margin:0 0 .2rem;font-weight:800}

/* meta */
.meta{display:grid;grid-template-columns:max-content 1fr;gap:.25rem .8rem;margin:0 0 1rem}
.meta__row{display:contents}
.meta dt{color:var(--fg-weak);font-weight:600}
.meta dd{margin:0}

/* === DMM埋め込み（UI込み4:3） === */
.fanza-embed{
  position:relative; width:100%; max-width:calc(var(--w)*1px);
  margin:0 auto 1rem; overflow:hidden; background:#000;
  border-radius:var(--radius); line-height:0; clear:both; isolation:isolate;
}
.fanza-embed--ui::before{ content:""; display:block; padding-top:75%; } /* ←ここが効く */
.fanza-embed > iframe{
  position:absolute; inset:0; width:100% !important; height:100% !important;
  border:0; display:block !important;
}
/* Cocoonの共通iframeルールを無効化 */
.entry-content iframe{ max-width:none !important; }

/* lead media (mp4/HLS フォールバック用) */
.lead-media{margin:0 0 .8rem}
.lead-media__video{width:100%;display:block;background:#000;border-radius:var(--radius);aspect-ratio:16/9}
.lead-media__cap{font-size:.9rem;color:var(--fg-weak);margin:.3rem 0 0}
.video-fallback{position:relative;display:block;border-radius:var(--radius);overflow:hidden}
.video-fallback img{width:100%;height:auto;display:block;aspect-ratio:16/9;object-fit:cover}
.video-fallback .playbtn{position:absolute;right:6%;bottom:6%;background:rgba(255,255,255,.92);color:#000;border-radius:999px;padding:.55em 1em;font-weight:800}

/* gallery */
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;margin:.8rem 0}
.gallery__item{margin:0}
.gallery__item img{width:100%;height:100%;aspect-ratio:3/2;object-fit:cover;border-radius:10px}

/* CTA */
.cta{
  margin:1.2rem 0 0;
  text-align:initial; /* 中央寄せを解除して幅100%に */
}
.cta__btn{
  display:block;
  width:100%;
  box-sizing:border-box;

  /* 見た目：四角く・目立つ */
  background:var(--brand);
  color:#000;
  border-radius:0;                /* ← 角丸をゼロに */
  border:3px solid #000;          /* 太枠でコントラスト */
  padding:1rem 1.25rem;

  font-weight:900;
  font-size:clamp(1rem, 0.9rem + 0.6vw, 1.25rem);
  line-height:1.2;
  text-decoration:none;
  text-align:center;
  letter-spacing:.02em;

  /* 立体感 */
  box-shadow:0 6px 0 rgba(0,0,0,.35);
  transition:transform .02s, box-shadow .2s, filter .2s;
}
.cta__btn:hover{
  filter:brightness(.96);
  box-shadow:0 3px 0 rgba(0,0,0,.35);
  transform:translateY(3px);
}
.cta__btn:active{
  transform:translateY(6px);
  box-shadow:0 0 0 rgba(0,0,0,0);
}
.cta__btn:focus-visible{
  outline:3px solid #111;
  outline-offset:3px;
}
</style>
